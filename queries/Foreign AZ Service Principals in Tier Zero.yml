name: Foreign AZ Service Principals in Tier Zero
guid: 4d567239-2e68-43e2-8f26-97655b8a37fb
prebuilt: false
platforms: Azure
category: Azure Hygiene
description: 
query: |-
  MATCH (sp:AZServicePrincipal)
  WHERE toUpper(sp.appownerorganizationid) <> toUpper(sp.tenantid)
  AND ((sp:Tag_Tier_Zero) OR COALESCE(sp.system_tags, '') CONTAINS 'admin_tier_0')
  // Ensure AZServicePrincipal has a valid appownerorganizationid
  AND sp.appownerorganizationid CONTAINS "-"
  RETURN sp
  LIMIT 1000
revision: 1
resources: https://posts.specterops.io/microsoft-breach-how-can-i-see-this-in-bloodhound-33c92dca4c65
acknowledgements: Stephen Hinck

